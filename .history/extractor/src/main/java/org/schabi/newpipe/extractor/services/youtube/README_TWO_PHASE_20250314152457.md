# Hướng dẫn sử dụng cơ chế tải 2 giai đoạn

Tài liệu này hướng dẫn cách sử dụng cơ chế tải 2 giai đoạn trong dự án WincaTubeExtractor để cải thiện trải nghiệm người dùng khi xem video YouTube.

## Giới thiệu

Cơ chế tải 2 giai đoạn cho phép ứng dụng tải các thông tin cần thiết để phát video ngay lập tức (URL phát, định dạng video/audio) trong giai đoạn 1, và tải các thông tin bổ sung dưới nền (mô tả, bình luận, video liên quan, v.v.) trong giai đoạn 2. Điều này giúp người dùng có thể xem video ngay lập tức sau khi nhấp vào, không phải đợi tải tất cả dữ liệu liên quan.

## Các lớp chính

1. `YoutubeStreamExtractorTwoPhase`: Lớp trích xuất hỗ trợ tải dữ liệu theo 2 giai đoạn.
2. `YoutubeServiceTwoPhase`: Lớp dịch vụ sử dụng `YoutubeStreamExtractorTwoPhase`.
3. `YoutubeStreamExtractorHelper`: Lớp tiện ích giúp ứng dụng Android sử dụng cơ chế tải 2 giai đoạn một cách dễ dàng.

## Cách sử dụng trong ứng dụng Android

### 1. Tải thông tin cần thiết để phát video ngay lập tức

```java
// Trong một AsyncTask hoặc coroutine
try {
    // Lấy thông tin cần thiết để phát video
    StreamInfo streamInfo = YoutubeStreamExtractorHelper.getEssentialInfo(videoUrl);
    
    // Lấy URL phát tốt nhất
    String playbackUrl = streamInfo.getVideoStreams().get(0).getUrl();
    
    // Bắt đầu phát video
    playVideo(playbackUrl);
    
    // Cập nhật UI với thông tin cơ bản
    updateBasicInfo(streamInfo);
} catch (Exception e) {
    // Xử lý lỗi
    handleError(e);
}
```

### 2. Tải thông tin bổ sung dưới nền

```java
// Tạo một ExecutorService để chạy tác vụ dưới nền
ExecutorService executorService = Executors.newSingleThreadExecutor();

// Tải thông tin bổ sung dưới nền
Future<StreamInfo> futureInfo = YoutubeStreamExtractorHelper.getAdditionalInfoAsync(
        videoUrl, executorService);

// Xử lý kết quả khi tải xong
executorService.execute(() -> {
    try {
        // Đợi kết quả
        StreamInfo fullInfo = futureInfo.get();
        
        // Cập nhật UI với thông tin đầy đủ
        runOnUiThread(() -> {
            updateFullInfo(fullInfo);
        });
    } catch (Exception e) {
        // Xử lý lỗi
        runOnUiThread(() -> {
            handleAdditionalInfoError(e);
        });
    }
});
```

### 3. Sử dụng trực tiếp các luồng video và âm thanh

```java
// Lấy danh sách các luồng video
List<VideoStream> videoStreams = YoutubeStreamExtractorHelper.getEssentialVideoStreams(videoUrl);

// Lấy danh sách các luồng âm thanh
List<AudioStream> audioStreams = YoutubeStreamExtractorHelper.getEssentialAudioStreams(videoUrl);

// Chọn luồng video và âm thanh tốt nhất
VideoStream bestVideoStream = getBestVideoStream(videoStreams);
AudioStream bestAudioStream = getBestAudioStream(audioStreams);

// Phát video với luồng video và âm thanh đã chọn
playVideoWithStreams(bestVideoStream, bestAudioStream);
```

## Tích hợp vào ứng dụng WincaTube_App

### 1. Thêm phụ thuộc vào WincaTubeExtractor

Đảm bảo rằng ứng dụng Android của bạn đã thêm phụ thuộc vào dự án WincaTubeExtractor:

```gradle
// build.gradle của ứng dụng
dependencies {
    implementation project(':extractor')
    // Các phụ thuộc khác...
}
```

### 2. Khởi tạo NewPipe trong ứng dụng Android

```java
// Trong Application.onCreate() hoặc MainActivity.onCreate()
private void initNewPipe() {
    // Khởi tạo NewPipe với Downloader của bạn
    NewPipe.init(DownloaderImpl.init(null), new Localization("vi", "VN"));
}
```

### 3. Tạo một lớp quản lý video

```java
public class VideoManager {
    private final ExecutorService executorService;
    
    public VideoManager() {
        executorService = Executors.newSingleThreadExecutor();
    }
    
    public void loadVideoForPlayback(String videoUrl, VideoLoadListener listener) {
        // Chạy trong một thread riêng
        new Thread(() -> {
            try {
                // Giai đoạn 1: Tải thông tin cần thiết để phát video
                StreamInfo essentialInfo = YoutubeStreamExtractorHelper.getEssentialInfo(videoUrl);
                
                // Thông báo cho listener
                listener.onEssentialInfoLoaded(essentialInfo);
                
                // Giai đoạn 2: Tải thông tin bổ sung dưới nền
                Future<StreamInfo> futureInfo = YoutubeStreamExtractorHelper.getAdditionalInfoAsync(
                        videoUrl, executorService);
                
                // Đợi kết quả
                StreamInfo fullInfo = futureInfo.get();
                
                // Thông báo cho listener
                listener.onAdditionalInfoLoaded(fullInfo);
            } catch (Exception e) {
                // Thông báo lỗi
                listener.onError(e);
            }
        }).start();
    }
    
    public interface VideoLoadListener {
        void onEssentialInfoLoaded(StreamInfo essentialInfo);
        void onAdditionalInfoLoaded(StreamInfo fullInfo);
        void onError(Exception e);
    }
}
```

### 4. Sử dụng VideoManager trong Activity hoặc Fragment

```java
public class VideoPlayerActivity extends AppCompatActivity implements VideoManager.VideoLoadListener {
    private VideoManager videoManager;
    private VideoView videoView;
    private TextView titleTextView;
    private TextView descriptionTextView;
    private RecyclerView relatedVideosRecyclerView;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_video_player);
        
        // Khởi tạo các view
        videoView = findViewById(R.id.video_view);
        titleTextView = findViewById(R.id.text_title);
        descriptionTextView = findViewById(R.id.text_description);
        relatedVideosRecyclerView = findViewById(R.id.recycler_related_videos);
        
        // Khởi tạo VideoManager
        videoManager = new VideoManager();
        
        // Lấy URL video từ intent
        String videoUrl = getIntent().getStringExtra("video_url");
        
        // Tải video
        videoManager.loadVideoForPlayback(videoUrl, this);
    }
    
    @Override
    public void onEssentialInfoLoaded(StreamInfo essentialInfo) {
        // Chạy trên UI thread
        runOnUiThread(() -> {
            // Cập nhật tiêu đề
            titleTextView.setText(essentialInfo.getName());
            
            // Lấy URL phát tốt nhất
            String playbackUrl = essentialInfo.getVideoStreams().get(0).getUrl();
            
            // Bắt đầu phát video
            videoView.setVideoURI(Uri.parse(playbackUrl));
            videoView.start();
        });
    }
    
    @Override
    public void onAdditionalInfoLoaded(StreamInfo fullInfo) {
        // Chạy trên UI thread
        runOnUiThread(() -> {
            // Cập nhật mô tả
            descriptionTextView.setText(fullInfo.getDescription().getContent());
            
            // Cập nhật danh sách video liên quan
            RelatedVideosAdapter adapter = new RelatedVideosAdapter(fullInfo.getRelatedItems());
            relatedVideosRecyclerView.setAdapter(adapter);
        });
    }
    
    @Override
    public void onError(Exception e) {
        // Chạy trên UI thread
        runOnUiThread(() -> {
            // Hiển thị thông báo lỗi
            Toast.makeText(this, "Lỗi: " + e.getMessage(), Toast.LENGTH_LONG).show();
        });
    }
}
```

## Lưu ý

1. Luôn gọi các phương thức trích xuất trong một thread riêng, không gọi trên UI thread.
2. Xử lý các ngoại lệ một cách thích hợp để tránh crash ứng dụng.
3. Sử dụng cơ chế cache để tránh tải lại dữ liệu khi người dùng quay lại video.
4. Kiểm tra kết nối mạng trước khi tải dữ liệu để tránh lỗi.

## Kết luận

Cơ chế tải 2 giai đoạn giúp cải thiện đáng kể trải nghiệm người dùng khi xem video YouTube trong ứng dụng của bạn. Bằng cách tải các thông tin cần thiết để phát video trước, người dùng có thể xem video ngay lập tức sau khi nhấp vào, đồng thời vẫn có đầy đủ thông tin bổ sung khi họ cần. 